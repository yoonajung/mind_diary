
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê°ì • í†µê³„ ë¦¬í¬íŠ¸</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #fdfdfd;
      padding: 40px;
      max-width: 800px;
      margin: auto;
    }
    h1 {
      color: #4a5e9d;
      text-align: center;
      margin-bottom: 30px;
    }
    canvas {
      max-width: 100%;
      margin-bottom: 40px;
    }
    .back {
      text-align: center;
      margin-top: 30px;
    }
    .back a {
      color: #4a5e9d;
      text-decoration: none;
      font-size: 16px;
    }
  </style>
</head>
<body>

  <h1>ğŸ“Š ê°ì • í†µê³„ ë¦¬í¬íŠ¸</h1>

  <canvas id="emotionTrendChart" height="100"></canvas>
  <canvas id="emotionCountChart" height="100"></canvas>

  <div class="back">
    <a href="index.html">â† í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAJDx7OA5wFBxBPDGpeLIHigQamFRK5ivY",
      authDomain: "my-mind-diary.firebaseapp.com",
      projectId: "my-mind-diary",
      storageBucket: "my-mind-diary.firebasestorage.app",
      messagingSenderId: "733502213796",
      appId: "1:733502213796:web:1fd8cdf51ec348f9606031"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const uid = localStorage.getItem("uid");
    if (!uid) {
      alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      location.href = "index.html";
    }

    const emotionMap = { "ğŸ˜Š": 5, "ğŸ˜": 3, "ğŸ˜¢": 1, "ğŸ˜ ": 2, "ğŸ˜´": 0 };
    const emotionLabels = ["ğŸ˜Š", "ğŸ˜", "ğŸ˜¢", "ğŸ˜ ", "ğŸ˜´"];

    db.collection("emotions")
      .where("uid", "==", uid)
      .orderBy("date", "desc")
      .limit(30)
      .get()
      .then(snapshot => {
        const trendData = [];
        const labels = [];
        const freq = { "ğŸ˜Š": 0, "ğŸ˜": 0, "ğŸ˜¢": 0, "ğŸ˜ ": 0, "ğŸ˜´": 0 };

        snapshot.forEach(doc => {
          const d = doc.data();
          if (d.emotion && d.date) {
            labels.unshift(d.date); // ìµœì‹  ë‚ ì§œë¥¼ ì˜¤ë¥¸ìª½ì—
            trendData.unshift(emotionMap[d.emotion]);
            freq[d.emotion] += 1;
          }
        });

        // ğŸ“ˆ Line Chart (ê°ì • ì¶”ì„¸)
        new Chart(document.getElementById("emotionTrendChart"), {
          type: "line",
          data: {
            labels: labels,
            datasets: [{
              label: "ê°ì • ë³€í™” (ìµœê·¼)",
              data: trendData,
              borderColor: "#4a90e2",
              backgroundColor: "rgba(74, 144, 226, 0.2)",
              tension: 0.3,
              fill: true,
              pointRadius: 4,
            }]
          },
          options: {
            scales: {
              y: {
                ticks: {
                  callback: value => {
                    const emoji = Object.keys(emotionMap).find(k => emotionMap[k] === value);
                    return emoji || "";
                  },
                  stepSize: 1,
                  beginAtZero: true,
                  max: 5
                }
              }
            }
          }
        });

        // ğŸ“Š Bar Chart (ê°ì • ë¹ˆë„)
        new Chart(document.getElementById("emotionCountChart"), {
          type: "bar",
          data: {
            labels: emotionLabels,
            datasets: [{
              label: "ê°ì • ë¹ˆë„",
              data: emotionLabels.map(e => freq[e]),
              backgroundColor: ["#ffcccb", "#dcdcdc", "#a3c9f1", "#ffc107", "#b0bec5"]
            }]
          }
        });

      }).catch(err => {
        console.error("í†µê³„ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err);
        alert("ê°ì • ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      });
  </script>

</body>
</html>
